"""🏠 Обзор — главная страница дашборда."""

import pathlib
import streamlit as st
import streamlit.components.v1 as components
from config import (
    TOTAL_CARDS, PCT_WITH_STORY, PCT_MAY, HALFLIFE_DAYS,
    NUM_LDA_TOPICS, DMI_GINI, SAMPLE_SIZE, AGE_GAP_RANGE,
)

APP_DIR = pathlib.Path(__file__).resolve().parent.parent
MEDIA_DIR = APP_DIR.parent / "media"
PRESENTATION_DIR = APP_DIR.parent / "presentation" / "index.html"

st.title("🎖️ Бессмертный полк — исследовательская витрина")

st.markdown(
    """
    Интерактивный дашборд для исследователей, историков и специалистов в области
    digital humanities. Данные охватывают **~981 тыс. карточек** ветеранов Великой
    Отечественной войны, размещённых на платформе «Бессмертный полк».
    """
)

# ── Метрики ───────────────────────────────────────────────────────
c1, c2, c3, c4 = st.columns(4)
c1.metric("Карточек", f"{TOTAL_CARDS:,}".replace(",", " "))
c2.metric("С текстом", f"{PCT_WITH_STORY}%")
c3.metric("Публикаций в мае", f"{PCT_MAY}%")
c4.metric("Полураспад активности", f"{HALFLIFE_DAYS} дней")

st.divider()

# ═══════════════════════════════════════════════════════════════════
# Медиа-пересказы
# ═══════════════════════════════════════════════════════════════════
st.subheader("Пересказ исследования")

mcol1, mcol2 = st.columns(2)

with mcol1:
    st.markdown("#### 🎧 Аудио-пересказ")
    audio_path = MEDIA_DIR / "Математика_миллиона_историй_Бессмертного_полка.m4a"
    if audio_path.exists():
        st.audio(str(audio_path), format="audio/m4a")
        st.caption("«Математика миллиона историй Бессмертного полка» · 19:04")
    else:
        st.info(
            "Аудиофайл будет доступен после размещения:\n"
            "`media/Математика_миллиона_историй_Бессмертного_полка.m4a`",
            icon="🎧",
        )
    
    st.markdown("#### 🖼️ Презентация")
    if PRESENTATION_DIR.exists():
        with open(PRESENTATION_DIR, 'r', encoding='utf-8') as f:
            html_content = f.read()
        # Используем встроенный компонент для отображения HTML с кнопкой новой вкладки
        components.html(
            f"""
            <script>
            var htmlContent = `{html_content}`;
            function openPresentation() {{
                var win = window.open();
                win.document.write(htmlContent);
                win.document.close();
            }}
            </script>
            <button onclick="openPresentation()" style="padding: 10px 20px; background-color: #1f77b4; color: white; text-decoration: none; border-radius: 5px; cursor: pointer; border: none; font-size: 16px;">📂 Открыть презентацию в новой вкладке</button>
            """,
            height=50
        )
    else:
        st.warning("Файл презентации не найден")

with mcol2:
    st.markdown("#### 🎬 Видео-пересказ")
    video_path = MEDIA_DIR / "Память_в_цифрах.mp4"
    if video_path.exists():
        st.video(str(video_path), format="video/mp4")
        st.caption("«Память в цифрах» · 6:37")
    else:
        st.info(
            "Видеофайл будет доступен после размещения:\n"
            "`media/Память_в_цифрах.mp4`",
            icon="🎬",
        )

st.divider()

# ═══════════════════════════════════════════════════════════════════
# Ключевые находки
# ═══════════════════════════════════════════════════════════════════
st.subheader("Пять ключевых находок")

findings = [
    (
        "📅 Сезонность памяти",
        f"Более {PCT_MAY}% карточек публикуются в мае — привязка к Дню Победы "
        f"создаёт ярко выраженный «пик памяти» с полураспадом около {HALFLIFE_DAYS} дней.",
    ),
    (
        "📝 Эволюция нарративов",
        f"Выявлены 4 типа текстов (формуляр, мемуар, семейная история, смешанный) "
        f"и {NUM_LDA_TOPICS} тематических кластеров. Лексическое разнообразие (MATTR) "
        "снижается — тексты становятся всё более шаблонными.",
    ),
    (
        "🗺️ География памяти",
        "46% карточек поданы не из региона рождения ветерана — "
        "миграция XX века отражается в пространственном распределении памяти.",
    ),
    (
        "🎖️ Возрастная конвергенция",
        f"Разрыв медианного возраста между рядовыми и офицерами сокращается "
        f"с {AGE_GAP_RANGE} к 1945 году — война уравнивала поколения.",
    ),
    (
        "📊 Неравенство документирования",
        f"Индекс цифровой памяти (DMI) распределён неравномерно: Gini = {DMI_GINI}. "
        "Регионы с большим объёмом карточек чаще имеют менее детальные записи.",
    ),
]

for title, text in findings:
    st.markdown(f"**{title}**")
    st.markdown(text)

st.divider()

# ═══════════════════════════════════════════════════════════════════
# Разделы дашборда
# ═══════════════════════════════════════════════════════════════════
st.subheader("Разделы дашборда")

nav_items = [
    ("📈", "Динамика", "Временные ряды публикаций, сезонность, полураспад активности."),
    ("📝", "Тексты", "Типы нарративов, тональность, лексическое разнообразие, тематическое моделирование, NER."),
    ("🗺️", "География", "Матрица миграции, межрегиональные связи, локальная vs. мигрировавшая память."),
    ("🎖️", "Демография", "Распределение возраста по званиям, конвергенция возрастных профилей."),
    ("📊", "DMI", "Индекс цифровой памяти, корреляции, неравенство по регионам."),
    ("🔎", "Поиск", "Полнотекстовый поиск по карточкам ветеранов с подсветкой и закладками."),
]

cols = st.columns(3)
for i, (icon, title, desc) in enumerate(nav_items):
    with cols[i % 3]:
        st.markdown(f"#### {icon} {title}")
        st.caption(desc)

st.divider()

# ═══════════════════════════════════════════════════════════════════
# Команда исследователей
# ═══════════════════════════════════════════════════════════════════
st.subheader("Команда исследователей")

team = [
    {
        "name": "Мельничук Дмитрий Вадимович",
        "role": "доцент, кафедра теории функций и стохастического анализа",
        "desc": "Прикладная математика, математическое моделирование, статистический анализ, теория случайных графов",
        "url": "https://www.sgu.ru/person/melnichuk-dmitriy-vadimovich",
    },
    {
        "name": "Тихонова Софья Владимировна",
        "role": "д.ф.н., профессор, кафедра теоретической и социальной философии",
        "desc": "Социальная философия цифрового общества, историческая память и её конструирование в медиапространстве",
        "url": "https://www.sgu.ru/person/tihonova-sofya-vladimirovna",
    },
    {
        "name": "Артамонов Денис Сергеевич",
        "role": "профессор, кафедра теоретической и социальной философии; зав. кафедрой методики преподавания истории",
        "desc": "Медиапамять в цифровом обществе, социальное конструирование исторической памяти",
        "url": "https://www.sgu.ru/person/artamonov-denis-sergeevich",
    },
    {
        "name": "Тихонов Глеб",
        "role": "студент",
        "desc": "Сбор и первичная обработка данных",
        "url": None,
    },
]

tcols = st.columns(2)
for i, member in enumerate(team):
    with tcols[i % 2]:
        with st.container(border=True):
            st.markdown(f"**{member['name']}**")
            st.caption(member["role"])
            st.markdown(member["desc"])
            if member["url"]:
                st.link_button("Профиль на сайте СГУ ↗", member["url"])

st.divider()

# ═══════════════════════════════════════════════════════════════════
# Грант
# ═══════════════════════════════════════════════════════════════════
st.subheader("Поддержка исследования")

st.markdown(
    """
    Исследование выполнено при поддержке **Российского научного фонда (РНФ)**,
    грант **№ 25-28-01261**.
    """
)

st.divider()

# ═══════════════════════════════════════════════════════════════════
# Публикации
# ═══════════════════════════════════════════════════════════════════
st.subheader("Публикации")

st.info(
    "Публикации по результатам исследования готовятся к выходу. "
    "Список будет обновлён после рецензирования и публикации статей.",
    icon="📄",
)

st.divider()

# ═══════════════════════════════════════════════════════════════════
# Цитирование
# ═══════════════════════════════════════════════════════════════════
st.subheader("Как цитировать")

st.code(
    'Бессмертный полк: исследовательская витрина [Электронный ресурс]. '
    '// Данные «Мой полк» (moypolk.ru), 981 467 карточек. '
    '— Грант РНФ № 25-28-01261. '
    'URL: https://moypolk-explorer.streamlit.app (дата обращения: ДД.ММ.ГГГГ).',
    language=None,
)

st.caption(
    "Данные собраны из открытых источников платформы moypolk.ru. "
    "Дашборд создан в исследовательских целях при поддержке РНФ."
)
