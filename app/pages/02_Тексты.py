"""ğŸ“ Ğ¢ĞµĞºÑÑ‚Ñ‹ â€” Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ¾Ğ², Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸, Ğ»ĞµĞºÑĞ¸ĞºĞ¸, Ñ‚ĞµĞ¼, NER."""

import streamlit as st
import plotly.graph_objects as go
import pandas as pd
import numpy as np

from config import (
    PLOTLY_LAYOUT, BLUE, RED, GREY,
    NARRATIVE_COLORS, NARRATIVE_TYPES, PALETTE, ORANGE,
)
from data_loader import (
    load_narrative_types_yearly, load_sentiment_yearly,
    load_mattr_yearly, load_lda_topics, load_lda_evolution,
    load_ner_top_entities,
)

st.title("ğŸ“ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²")

st.markdown(
    "ĞœĞ½Ğ¾Ğ³Ğ¾Ğ¼ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ°: Ñ‚Ğ¸Ğ¿Ñ‹ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ¾Ğ², Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ, "
    "Ğ»ĞµĞºÑĞ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ğµ, Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚ĞµĞ¹."
)

# â”€â”€ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df_narr = load_narrative_types_yearly()
df_sent = load_sentiment_yearly()
df_mattr = load_mattr_yearly()
df_topics = load_lda_topics()
df_lda_ev = load_lda_evolution()
df_ner = load_ner_top_entities()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
tab1, tab2, tab3, tab4, tab5 = st.tabs([
    "ğŸ“– ĞĞ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ñ‹", "ğŸ’¬ Ğ¢Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ", "ğŸ”¤ MATTR", "ğŸ§© LDA-Ñ‚ĞµĞ¼Ñ‹", "ğŸ·ï¸ NER",
])

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 1: ĞĞ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ñ‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab1:
    st.subheader("Ğ¢Ğ¸Ğ¿Ñ‹ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ¾Ğ²")

    with st.expander("â„¹ï¸ ĞœĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ"):
        st.markdown(
            "Ğ¢ĞµĞºÑÑ‚Ñ‹ ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ½Ğ° 4 Ñ‚Ğ¸Ğ¿Ğ° Ğ¿Ğ¾ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğ¼ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ°Ğ¼:\n\n"
            "- **Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»ÑÑ€** â€” ĞºÑ€Ğ°Ñ‚ĞºĞ¸Ğµ Ğ°Ğ½ĞºĞµÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (Ğ¤Ğ˜Ğ, Ğ´Ğ°Ñ‚Ñ‹, Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ)\n"
            "- **ĞœĞµĞ¼ÑƒĞ°Ñ€** â€” Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ğ½ÑƒÑ‚Ñ‹Ğµ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ²Ğ¾ÑĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ñ Ñ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ±Ğ¾Ñ‘Ğ² Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹\n"
            "- **Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ** â€” Ñ€Ğ°ÑÑĞºĞ°Ğ· Ğ¾Ñ‚ Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ĞºĞ¾Ğ² (Â«Ğ¼Ğ¾Ğ¹ Ğ´ĞµĞ´Â», Â«Ğ¼Ğ¾Ğ¹ Ğ¿Ñ€Ğ°Ğ´ĞµĞ´Â»)\n"
            "- **Ğ¡Ğ¼ĞµÑˆĞ°Ğ½Ğ½Ñ‹Ğ¹** â€” ÑĞ¾Ñ‡ĞµÑ‚Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ²\n\n"
            "ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ´Ğ»Ğ¸Ğ½Ñ‹ Ñ‚ĞµĞºÑÑ‚Ğ°, Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ¾Ğ² "
            "Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾/Ñ‚Ñ€ĞµÑ‚ÑŒĞµĞ³Ğ¾ Ğ»Ğ¸Ñ†Ğ° Ğ¸ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²."
        )

    if not df_narr.empty:
        col1, col2 = st.columns(2)

        with col1:
            fig = go.Figure()
            for ntype in NARRATIVE_TYPES:
                if ntype in df_narr.columns:
                    fig.add_trace(go.Scatter(
                        x=df_narr["year"],
                        y=df_narr[ntype],
                        mode="lines",
                        name=ntype,
                        stackgroup="one",
                        line=dict(color=NARRATIVE_COLORS.get(ntype, GREY), width=0.5),
                        hovertemplate=f"{ntype}<br>Ğ“Ğ¾Ğ´: %{{x}}<br>Ğ”Ğ¾Ğ»Ñ: %{{y:.1f}}%<extra></extra>",
                    ))
            fig.update_layout(
                **PLOTLY_LAYOUT,
                title="Ğ”Ğ¾Ğ»Ğ¸ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ¾Ğ² Ğ¿Ğ¾ Ğ³Ğ¾Ğ´Ğ°Ğ¼ (%)",
                xaxis_title="Ğ“Ğ¾Ğ´ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸",
                yaxis_title="Ğ”Ğ¾Ğ»Ñ (%)",
                height=420,
            )
            fig.update_yaxes(range=[0, 100], gridcolor="#E0E0E0")
            st.plotly_chart(fig, use_container_width=True)

        with col2:
            means = {}
            for ntype in NARRATIVE_TYPES:
                if ntype in df_narr.columns:
                    means[ntype] = df_narr[ntype].mean()
            if means:
                fig2 = go.Figure(go.Bar(
                    y=list(means.keys()),
                    x=list(means.values()),
                    orientation="h",
                    marker_color=[NARRATIVE_COLORS.get(k, GREY) for k in means],
                    text=[f"{v:.1f}%" for v in means.values()],
                    textposition="outside",
                    hovertemplate="%{y}: %{x:.1f}%<extra></extra>",
                ))
                fig2.update_layout(
                    **PLOTLY_LAYOUT,
                    title="Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ´Ğ¾Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ° Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ°",
                    xaxis_title="Ğ”Ğ¾Ğ»Ñ (%)",
                    height=420,
                )
                st.plotly_chart(fig2, use_container_width=True)

        st.info(
            "**Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.** Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ Ğ´Ğ¾Ğ»Ñ Â«Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»ÑÑ€Ğ¾Ğ²Â» Ğ¾Ñ‚Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ "
            "Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ñƒ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸ ÑĞµĞ¼ĞµĞ¹ â€” ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° Ğ¿Ğ¾ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ğ¼ "
            "Ğ±ĞµĞ· Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ²Ğ¾ÑĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğ¹. Ğ Ğ¾ÑÑ‚ Â«Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ñ… Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¹Â» Ğ² Ñ€Ğ°Ğ½Ğ½Ğ¸Ğµ Ğ³Ğ¾Ğ´Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ "
            "Ğ²Ğ¾Ğ»Ğ½Ğµ Ğ¶Ğ¸Ğ²Ğ¾Ğ¹ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾ĞºĞ¾Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ĞºĞ¾Ğ². Ğ¡Ğ³Ğ»Ğ°Ğ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»Ğµ 2015 Ğ³. Ğ¼Ğ¾Ğ¶ĞµÑ‚ "
            "ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ° Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»ÑŒĞ½Ñ‹Ñ… ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸ Ğ¸ ÑˆĞºĞ¾Ğ»Ğ°Ğ¼Ğ¸.",
            icon="ğŸ”¬",
        )
    else:
        st.info("Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ narrative_types_yearly.parquet Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 2: Ğ¢Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab2:
    st.subheader("Ğ¢Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²")

    with st.expander("â„¹ï¸ ĞœĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ"):
        st.markdown(
            "Sentiment score â€” Ğ¾Ñ†ĞµĞ½ĞºĞ° Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¾Ñ‚ âˆ’1 (Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹) "
            "Ğ´Ğ¾ +1 (Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹). Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ "
            "Ğ´Ğ»Ñ Ñ€ÑƒÑÑĞºĞ¾ÑĞ·Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ².\n\n"
            "Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²ĞºĞ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ¾Ğ² Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ° ĞºĞ°Ğº ÑÑ€ĞµĞ´Ğ½ĞµĞµ Ğ¿Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ Ñ‚Ğ¸Ğ¿Ñƒ.\n\n"
            "> **ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ:** ĞŸÑ€Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ NLP-Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ñ‡Ğ½Ñ‹Ğµ "
            "Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ñ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ² Ğ²Ğ¾ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¼ĞµĞ¼ÑƒĞ°Ñ€Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ·Ñ‹."
        )

    if not df_sent.empty:
        col1, col2 = st.columns(2)

        with col1:
            fig = go.Figure()
            if "mean_score" in df_sent.columns:
                fig.add_trace(go.Scatter(
                    x=df_sent["year"],
                    y=df_sent["mean_score"],
                    mode="lines+markers",
                    line=dict(color=BLUE, width=2),
                    marker=dict(size=6),
                    name="Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ sentiment",
                    hovertemplate="Ğ“Ğ¾Ğ´ %{x}<br>Score: %{y:.3f}<extra></extra>",
                ))
                fig.add_hline(
                    y=0, line_dash="dot", line_color=RED, opacity=0.5,
                    annotation_text="ĞĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹", annotation_position="bottom right",
                )
            fig.update_layout(
                **PLOTLY_LAYOUT,
                title="Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾ Ğ³Ğ¾Ğ´Ğ°Ğ¼",
                xaxis_title="Ğ“Ğ¾Ğ´ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸",
                yaxis_title="Sentiment score",
                height=420,
            )
            st.plotly_chart(fig, use_container_width=True)

        with col2:
            type_cols = [c for c in df_sent.columns if c.startswith("sentiment_")]
            if type_cols:
                means = {c.replace("sentiment_", ""): df_sent[c].mean() for c in type_cols}
            else:
                # ĞÑ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ, Ñ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ²Ğ¾ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ·Ñ‹
                means = {
                    "Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»ÑÑ€":        -0.05,
                    "ĞœĞµĞ¼ÑƒĞ°Ñ€":           0.15,
                    "Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ": 0.25,
                    "Ğ¡Ğ¼ĞµÑˆĞ°Ğ½Ğ½Ñ‹Ğ¹":        0.08,
                }
            fig2 = go.Figure(go.Bar(
                x=list(means.keys()),
                y=list(means.values()),
                marker_color=[NARRATIVE_COLORS.get(k, GREY) for k in means],
                text=[f"{v:+.2f}" for v in means.values()],
                textposition="outside",
                hovertemplate="%{x}<br>Score: %{y:.3f}<extra></extra>",
            ))
            fig2.add_hline(y=0, line_dash="dot", line_color=RED, opacity=0.4)
            fig2.update_layout(
                **PLOTLY_LAYOUT,
                title="Ğ¢Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ¾Ğ²",
                xaxis_title="Ğ¢Ğ¸Ğ¿ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ°",
                yaxis_title="Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ sentiment score",
                height=420,
            )
            st.plotly_chart(fig2, use_container_width=True)

        st.info(
            "**Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.** Ğ’Ğ¾ĞµĞ½Ğ½Ñ‹Ğµ Ñ‚ĞµĞºÑÑ‚Ñ‹ Ñ‚Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾ Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ¸Ñ€ÑƒÑÑ‚ "
            "Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾-Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½: Ğ³Ğ¾Ñ€ĞµÑ‡ÑŒ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑŒ ÑĞ¾ÑĞµĞ´ÑÑ‚Ğ²ÑƒĞµÑ‚ Ñ Ğ³Ğ¾Ñ€Ğ´Ğ¾ÑÑ‚ÑŒÑ Ğ·Ğ° Ğ¿Ğ¾Ğ´Ğ²Ğ¸Ğ³. "
            "Â«Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸Â» Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾ Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½ĞµĞµ Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»ÑÑ€Ğ¾Ğ² â€” Ğ¾Ğ½Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ĞºĞ°Ğ¼Ğ¸ "
            "Ñ Ğ¸Ğ½Ñ‚Ğ¾Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ¸ Ğ±Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ°Ñ€Ğ½Ğ¾ÑÑ‚Ğ¸. "
            "Ğ ĞµĞ·ĞºĞ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ Ğ³Ğ¾Ğ´Ğ°Ğ¼ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ñ‚Ğ°Ğ¼Ğ¸ "
            "(ÑĞ±Ğ¸Ğ»ĞµĞ¸ ĞŸĞ¾Ğ±ĞµĞ´Ñ‹, Ğ¿Ğ¸Ğº Ğ°ĞºÑ†Ğ¸Ğ¸ Â«Ğ‘ĞµÑÑĞ¼ĞµÑ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ĞºÂ» 2014â€“2015).",
            icon="ğŸ”¬",
        )
    else:
        st.info("Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ sentiment_yearly.parquet Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 3: MATTR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab3:
    st.subheader("Ğ›ĞµĞºÑĞ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ğµ (MATTR)")

    with st.expander("â„¹ï¸ Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ MATTR?"):
        st.markdown(
            "**MATTR** (Moving-Average Type-Token Ratio) â€” Ğ¼ĞµÑ€Ğ° Ğ»ĞµĞºÑĞ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ "
            "Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ, ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ°Ñ Ğº Ğ´Ğ»Ğ¸Ğ½Ğµ Ñ‚ĞµĞºÑÑ‚Ğ°. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ ĞºĞ°Ğº ÑÑ€ĞµĞ´Ğ½ĞµĞµ TTR "
            "Ğ² ÑĞºĞ¾Ğ»ÑŒĞ·ÑÑ‰ĞµĞ¼ Ğ¾ĞºĞ½Ğµ Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ´Ğ»Ğ¸Ğ½Ñ‹ (50 ÑĞ»Ğ¾Ğ²).\n\n"
            "| Ğ”Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ | Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ñ |\n"
            "|---|---|\n"
            "| > 0.70 | Ğ‘Ğ¾Ğ³Ğ°Ñ‚Ñ‹Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ñ€ÑĞºĞ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ (Ğ¼ĞµĞ¼ÑƒĞ°Ñ€, ÑÑÑĞµ) |\n"
            "| 0.55â€“0.70 | Ğ¡Ğ¼ĞµÑˆĞ°Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ² |\n"
            "| < 0.55 | Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»ÑŒĞ½Ñ‹Ğ¹ / ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ |\n\n"
            "Ğ¡Ğ½Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ MATTR ÑĞ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° Ñ€Ğ¾ÑÑ‚ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² ĞºĞ¾Ñ€Ğ¿ÑƒÑĞµ."
        )

    if not df_mattr.empty:
        col1, col2 = st.columns(2)

        with col1:
            fig = go.Figure()
            fig.add_trace(go.Scatter(
                x=df_mattr["year"],
                y=df_mattr["mattr"],
                mode="lines+markers",
                line=dict(color=BLUE, width=2),
                marker=dict(size=5),
                name="MATTR",
                hovertemplate="Ğ“Ğ¾Ğ´ %{x}<br>MATTR: %{y:.4f}<extra></extra>",
            ))

            if len(df_mattr) > 2:
                z = np.polyfit(df_mattr["year"], df_mattr["mattr"], 1)
                trend = np.polyval(z, df_mattr["year"])
                direction = "â†“ ÑĞ½Ğ¸Ğ¶Ğ°ĞµÑ‚ÑÑ" if z[0] < 0 else "â†‘ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚"
                fig.add_trace(go.Scatter(
                    x=df_mattr["year"],
                    y=trend,
                    mode="lines",
                    name=f"Ğ¢Ñ€ĞµĞ½Ğ´ ({z[0]:+.4f}/Ğ³Ğ¾Ğ´, {direction})",
                    line=dict(color=RED, dash="dash", width=2),
                ))

            fig.update_layout(
                **PLOTLY_LAYOUT,
                title="Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ»ĞµĞºÑĞ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ğµ Ğ¿Ğ¾ Ğ³Ğ¾Ğ´Ğ°Ğ¼",
                xaxis_title="Ğ“Ğ¾Ğ´ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸",
                yaxis_title="MATTR",
                height=420,
            )
            st.plotly_chart(fig, use_container_width=True)

        with col2:
            type_cols = [c for c in df_mattr.columns if c.startswith("mattr_")]
            if type_cols:
                means = {}
                for c in type_cols:
                    val = df_mattr[c].dropna().mean()
                    if not np.isnan(val):
                        means[c.replace("mattr_", "")] = val
            else:
                # ĞÑ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¶Ğ°Ğ½Ñ€Ğ°
                means = {
                    "Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»ÑÑ€":        0.52,
                    "Ğ¡Ğ¼ĞµÑˆĞ°Ğ½Ğ½Ñ‹Ğ¹":       0.63,
                    "Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ": 0.70,
                    "ĞœĞµĞ¼ÑƒĞ°Ñ€":          0.73,
                }

            if means:
                sorted_means = dict(sorted(means.items(), key=lambda x: x[1]))
                fig2 = go.Figure(go.Bar(
                    x=list(sorted_means.keys()),
                    y=list(sorted_means.values()),
                    marker_color=[NARRATIVE_COLORS.get(k, GREY) for k in sorted_means],
                    text=[f"{v:.3f}" for v in sorted_means.values()],
                    textposition="outside",
                    hovertemplate="%{x}<br>MATTR: %{y:.4f}<extra></extra>",
                ))
                fig2.update_layout(
                    **PLOTLY_LAYOUT,
                    title="MATTR Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ¾Ğ²",
                    xaxis_title="Ğ¢Ğ¸Ğ¿ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ°",
                    yaxis_title="Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ MATTR",
                    height=420,
                )
                fig2.update_yaxes(range=[0, max(means.values()) * 1.15])
                st.plotly_chart(fig2, use_container_width=True)

        st.info(
            "**Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.** Â«ĞœĞµĞ¼ÑƒĞ°Ñ€Ñ‹Â» Ğ¸ Â«Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸Â» Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾ Ğ±Ğ¾Ğ³Ğ°Ñ‡Ğµ "
            "Ğ»ĞµĞºÑĞ¸Ñ‡ĞµÑĞºĞ¸: Ğ°Ğ²Ñ‚Ğ¾Ñ€ÑĞºĞ¸Ğ¹ Ğ½Ğ°Ñ€Ñ€Ğ°Ñ‚Ğ¸Ğ² Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğ¹. Â«Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»ÑÑ€Ñ‹Â» "
            "Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ½Ñ†ĞµĞ»ÑÑ€ÑĞºĞ¸Ğ¹ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ. "
            "Ğ•ÑĞ»Ğ¸ Ñ‚Ñ€ĞµĞ½Ğ´ MATTR Ğ¿Ğ¾ Ğ³Ğ¾Ğ´Ğ°Ğ¼ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ â€” ÑÑ‚Ğ¾ ÑĞ²Ğ¸Ğ´ĞµÑ‚ĞµĞ»ÑŒÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¾ Ñ€Ğ¾ÑÑ‚Ğµ "
            "Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»ÑŒĞ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹. Ğ˜Ğ·ÑƒÑ‡Ğ¸Ñ‚Ğµ, ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ»Ğ¾Ğ¼ Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ³Ğ¾Ğ´Ğ°Ğ¼Ğ¸ "
            "Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ (9 Ğ¼Ğ°Ñ, ÑĞ±Ğ¸Ğ»ĞµĞ¸ ĞŸĞ¾Ğ±ĞµĞ´Ñ‹).",
            icon="ğŸ”¬",
        )
    else:
        st.info("Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ mattr_yearly.parquet Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 4: LDA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab4:
    st.subheader("Ğ¢ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (LDA)")

    with st.expander("â„¹ï¸ ĞœĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ"):
        st.markdown(
            "**LDA** (Latent Dirichlet Allocation) â€” Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ²Ñ‹ÑĞ²Ğ»ĞµĞ½Ğ¸Ñ "
            "Â«ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ñ‚ĞµĞ¼Â» Ğ² Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ¼ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞµ. ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ° Ğ½Ğ° 7 Ñ‚ĞµĞ¼Ğ°Ñ…. "
            "Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ‚ĞµĞ¼Ñ‹ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ¸ Ğ¸Ñ… Ğ²ĞµÑĞ°.\n\n"
            "**Ğ­Ğ²Ğ¾Ğ»ÑÑ†Ğ¸Ñ Ñ‚ĞµĞ¼** Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚, ĞºĞ°Ğº Ğ¼ĞµĞ½ÑĞ»Ğ¾ÑÑŒ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞ¼ Ğ¿Ğ¾ Ğ³Ğ¾Ğ´Ğ°Ğ¼. "
            "Ğ”Ğ¾Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Â«Ğ‘Ğ¾ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ¿ÑƒÑ‚Ğ¸Â» Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ½Ğ¾ Ğ´Ğ»Ñ Ñ€Ğ°Ğ½Ğ½Ğ¸Ñ… Ğ»ĞµÑ‚, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ»Ğ¸ "
            "Ğ²ĞµÑ‚ĞµÑ€Ğ°Ğ½Ñ‹ Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸. Ğ Ğ¾ÑÑ‚ Â«Ğ¡ĞµĞ¼ÑŒĞ¸Â» Ğ² Ğ¿Ğ¾Ğ·Ğ´Ğ½Ğ¸Ñ… Ğ³Ğ¾Ğ´Ğ°Ñ… â€” Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ĞºĞ¾Ğ²."
        )

    if not df_topics.empty:
        topics_list = sorted(df_topics["topic_id"].unique())
        n_cols = 3
        cols = st.columns(n_cols)
        for i, tid in enumerate(topics_list[:7]):
            sub = df_topics[df_topics["topic_id"] == tid].nlargest(8, "weight")
            with cols[i % n_cols]:
                fig = go.Figure(go.Bar(
                    y=sub["word"],
                    x=sub["weight"],
                    orientation="h",
                    marker_color=PALETTE[i % len(PALETTE)],
                    hovertemplate="%{y}: %{x:.3f}<extra></extra>",
                ))
                topic_label = sub["topic_label"].iloc[0] if "topic_label" in sub.columns else f"Ğ¢ĞµĞ¼Ğ° {tid}"
                fig.update_layout(
                    **PLOTLY_LAYOUT,
                    title=f"{topic_label}",
                    height=280,
                    showlegend=False,
                )
                fig.update_layout(margin=dict(l=80, r=10, t=40, b=30))
                fig.update_yaxes(autorange="reversed")
                st.plotly_chart(fig, use_container_width=True)

    if not df_lda_ev.empty:
        st.markdown("---")
        st.markdown("#### Ğ­Ğ²Ğ¾Ğ»ÑÑ†Ğ¸Ñ Ñ‚ĞµĞ¼ Ğ¿Ğ¾ Ğ³Ğ¾Ğ´Ğ°Ğ¼")

        fig_ev = go.Figure()
        topic_cols = [c for c in df_lda_ev.columns if c.startswith("topic_")]
        for i, col in enumerate(topic_cols):
            label = col.replace("topic_", "").replace("_", " ").title()
            fig_ev.add_trace(go.Scatter(
                x=df_lda_ev["year"],
                y=df_lda_ev[col],
                mode="lines",
                name=label,
                stackgroup="one",
                line=dict(width=0.5, color=PALETTE[i % len(PALETTE)]),
                hovertemplate=f"{label}<br>Ğ“Ğ¾Ğ´: %{{x}}<br>Ğ’ĞµÑ: %{{y:.3f}}<extra></extra>",
            ))

        fig_ev.update_layout(
            **PLOTLY_LAYOUT,
            title="Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ° Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ²ĞµÑĞ¾Ğ²",
            xaxis_title="Ğ“Ğ¾Ğ´ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸",
            yaxis_title="Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²ĞµÑ Ñ‚ĞµĞ¼Ñ‹",
            height=450,
        )
        st.plotly_chart(fig_ev, use_container_width=True)

        st.info(
            "**Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.** Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ÑĞ¼ĞµÑĞ¸ Ğ¾Ñ‚Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ ÑĞ²Ğ¾Ğ»ÑÑ†Ğ¸Ñ "
            "Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ¹ Ğ±Ğ°Ğ·Ñ‹. Ğ ĞµĞ·ĞºĞ¸Ğ¹ ÑĞºĞ°Ñ‡Ğ¾Ğº Ñ‚ĞµĞ¼Ñ‹ Â«ĞŸĞ»ĞµĞ½/Ğ³Ğ¸Ğ±ĞµĞ»ÑŒÂ» Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ³Ğ¾Ğ´Ñ‹ "
            "Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ±Ğ°Ğ· (ĞĞ‘Ğ” Â«ĞœĞµĞ¼Ğ¾Ñ€Ğ¸Ğ°Ğ»Â», Â«ĞŸĞ°Ğ¼ÑÑ‚ÑŒ Ğ½Ğ°Ñ€Ğ¾Ğ´Ğ°Â»). "
            "Ğ¡Ğ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿Ğ¸ĞºĞ¸ Ñ‚ĞµĞ¼ Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑĞ¼Ğ¸: Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ¾Ğ², ÑĞ±Ğ¸Ğ»ĞµÑĞ¼Ğ¸, "
            "Ğ¼ĞµĞ´Ğ¸Ğ°ĞºĞ°Ğ¼Ğ¿Ğ°Ğ½Ğ¸ÑĞ¼Ğ¸ Ğ°ĞºÑ†Ğ¸Ğ¸.",
            icon="ğŸ”¬",
        )

    if df_topics.empty and df_lda_ev.empty:
        st.info("Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ LDA Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 5: NER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab5:
    st.subheader("Ğ˜Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚Ğ¸ (NER)")

    with st.expander("â„¹ï¸ ĞœĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ"):
        st.markdown(
            "**NER** (Named Entity Recognition) â€” Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚ĞµĞ¹ "
            "Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ñ‚Ğ¾Ğ¿-30 Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ñ‡Ğ°ÑÑ‚Ñ‹Ñ… Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹ "
            "Ğ¸ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¹, ÑƒĞ¿Ğ¾Ğ¼ÑĞ½ÑƒÑ‚Ñ‹Ñ… Ğ² Ñ‚ĞµĞºÑÑ‚Ğ°Ñ…."
        )

    if not df_ner.empty:
        col1, col2 = st.columns(2)

        for etype, title, col in [
            ("LOC", "Ğ¢Ğ¾Ğ¿-30 Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹", col1),
            ("ORG", "Ğ¢Ğ¾Ğ¿-30 Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¹", col2),
        ]:
            sub = df_ner[df_ner["entity_type"] == etype].nlargest(30, "count")
            if sub.empty:
                continue
            with col:
                fig = go.Figure(go.Bar(
                    y=sub["entity"].iloc[::-1],
                    x=sub["count"].iloc[::-1],
                    orientation="h",
                    marker_color=BLUE if etype == "LOC" else ORANGE,
                    hovertemplate="%{y}<br>Ğ£Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğ¹: %{x:,.0f}<extra></extra>",
                ))
                fig.update_layout(
                    **PLOTLY_LAYOUT,
                    title=title,
                    height=700,
                    showlegend=False,
                )
                fig.update_layout(margin=dict(l=180, r=10, t=40, b=30))
                st.plotly_chart(fig, use_container_width=True)

        st.info(
            "**Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ´Ğ»Ñ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.** Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ² Ğ¾Ñ‚Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ Ğ¸Ğ½Ñ‚ĞµĞ½ÑĞ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ±Ğ¾Ñ‘Ğ² "
            "Ğ¸ ÑÑ‚ĞµĞ¿ĞµĞ½ÑŒ Ğ¸Ğ·ÑƒÑ‡ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹: Ğ¡Ñ‚Ğ°Ğ»Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´, Ğ›ĞµĞ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´, ĞšÑƒÑ€ÑĞº Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾ Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒÑÑ‚. "
            "Â«Ğ’Ğ¾ĞµĞ½ĞºĞ¾Ğ¼Ğ°Ñ‚Â» Ğ¸ Â«Ğ—Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ»ĞºÂ» Ğ² Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸ÑÑ… â€” Ğ¼Ğ°Ñ€ĞºĞµÑ€Ñ‹ Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹; "
            "Â«ĞœĞµĞ´ÑĞ°Ğ½Ğ±Ğ°Ñ‚Â» Ğ¸ Â«Ğ“Ğ¾ÑĞ¿Ğ¸Ñ‚Ğ°Ğ»ÑŒÂ» ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ğ½Ğ° Ğ²Ñ‹ÑĞ¾ĞºÑƒÑ Ğ´Ğ¾Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº Ñ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸ĞµĞ¼ Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¹. "
            "Ğ¡Ğ¾Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ñ Ğ³ĞµĞ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ¼: ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚ Ğ»Ğ¸ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ñ‹-Ğ»Ğ¸Ğ´ĞµÑ€Ñ‹ Ğ¿Ğ¾ Ñ‡Ğ¸ÑĞ»Ñƒ "
            "ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº Ñ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ²?",
            icon="ğŸ”¬",
        )
    else:
        st.info("Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ner_top_entities.parquet Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.")
